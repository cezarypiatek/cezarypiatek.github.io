<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">   
	<meta name="theme-color" content="#ffffff">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="Which analyzer package should I use and how to configure it to avoid most common problems related to async/await.">   
    <script type="application/ld+json">
        {
          "@context" : "http://schema.org",
          "@type": "BlogPosting",
            "mainEntityOfPage":{
            "@type":"WebPage",
            "@id":"https:\/\/cezarypiatek.github.io\/post\/async-analyzers-p1\/"
            },
          "headline" : "Async code smells and how to track them down with analyzers - Part I",
          "author" : {
            "@type" : "Person",
            "name" : "CEZARY PIƒÑTEK"
          },
          "publisher" : {
            "@type" : "Person",
            "name" : "CEZARY PIƒÑTEK"
          },
          "datePublished" : "2020-10-11",
          "dateModified" : "2020-10-18",
          "image" : "https:\/\/cezarypiatek.github.io\/post\/async-analyzers-p1\/splashscreen.jpg",
          "description": "Which analyzer package should I use and how to configure it to avoid most common problems related to async\/await."
        }
        </script>
        
    <meta property="article:published_time" content="2020-10-11">
	<meta property="og:type" content="article">
    
	<meta property="og:locale" content="en_US">	
	<meta property="og:url" content="https://cezarypiatek.github.io/post/async-analyzers-p1/">	
	<meta property="og:title" content="Async code smells and how to track them down with analyzers - Part I">
	<meta property="og:image" content="https://cezarypiatek.github.io/post/async-analyzers-p1/splashscreen.jpg">
    <meta property="og:description" content="Which analyzer package should I use and how to configure it to avoid most common problems related to async/await.">
    <meta property="og:site_name" content="Cezary PiƒÖtek Blog">
    
    <meta property="og:tags" content="dotnet">
    
    <meta property="og:tags" content="csharp">
    
    <meta property="og:tags" content="async">
    
    <meta property="og:tags" content="roslyn">
    
    <meta property="og:tags" content="analyzers">
    
	<meta property="twitter:card" content="summary_large_image" >
	<meta property="twitter:image" content="https://cezarypiatek.github.io/post/async-analyzers-p1/splashscreen.jpg">
	<meta property="twitter:title" content="Async code smells and how to track them down with analyzers - Part I">	
	<meta property="twitter:creator" content="@cezary_piatek">
	<meta property="twitter:description" content="Which analyzer package should I use and how to configure it to avoid most common problems related to async/await.">

	<meta name="keywords" value="dotnet, csharp, async, roslyn, analyzers" />
    <meta name="generator" content="Hugo 0.74.3" />
    <title>Async code smells and how to track them down with analyzers - Part I &middot; Cezary PiƒÖtek Blog</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/a11y-dark.min.css">
    
    <link rel="stylesheet" href="https://cezarypiatek.github.io/css/style.css">
    <link rel="stylesheet" href="https://cezarypiatek.github.io/lib/gifplayer/gifplayer.css">
    
    <link href="https://cezarypiatek.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Cezary PiƒÖtek Blog" />
        
	<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
	<link rel="manifest" href="../../manifest.json">
  <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/story-show-gallery@2/dist/ssg.min.css">
    
    
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="https://cezarypiatek.github.io/">CEZARY PIƒÑTEK</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="https://cezarypiatek.github.io/">Blog</a></li>
				
					<li><a href="https://cezarypiatek.github.io/projects/">Projects</a></li>
				
					<li><a href="https://cezarypiatek.github.io/public-speaking/">Public speaking</a></li>
				
					<li><a href="https://cezarypiatek.github.io/about/">About me</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="https://cezarypiatek.github.io/">CEZARY PIƒÑTEK</a></h1>
		
		
		
			<small class="text-center center-block">Natural born software developer</small>
		
		
		
			<img id="profile-pic" src="https://cezarypiatek.github.io//images/7759991.jpg" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			
				<a href="https://github.com/cezarypiatek" title="Check my Open Source works"><i class="fa fa-github fa-2x"></i></a>
			
				<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fpublish.twitter.com%2F%3FbuttonType%3DFollowButton%26query%3D%2540cezary_piatek%26widget%3DButton&amp;ref_src=twsrc%5Etfw&amp;region=follow_link&amp;screen_name=cezary_piatek&amp;tw_p=followbutton" title="Follow me on Twitter"><i class="fa fa-twitter fa-2x"></i></a>
			
				<a href="https://www.linkedin.com/in/cezary-pi%C4%85tek-373737185/" title="Follow me on LinkedIn"><i class="fa fa-linkedin fa-2x"></i></a>
			
				<a href="https://stackoverflow.com/users/876060/cezarypiatek" title="Check my StackOverflow profile"><i class="fa fa-stack-overflow fa-2x"></i></a>
			
				<a href="../../index.xml" title="Be up to date - subscribe to my rss feed channel"><i class="fa fa-rss fa-2x"></i></a>
			

			
		</div>
		<div id="links" class="text-center">
			
			
				<a href="https://cezarypiatek.github.io/">Blog</a>
			
				<a href="https://cezarypiatek.github.io/projects/">Projects</a>
			
				<a href="https://cezarypiatek.github.io/public-speaking/">Public speaking</a>
			
				<a href="https://cezarypiatek.github.io/about/">About me</a>
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8 ssg">

<main>
	<article>
		<header>
			<h1>Async code smells and how to track them down with analyzers - Part I</h1>
			  
			<div><i class="fa fa-calendar"></i> <time>11 October 2020</time></div>
			<hr />
			
		</header>
		
			<img src="splashscreen.jpg" width="100%" />
			<br />
		
		<p>Roslyn analyzers are great. Not only do they detect different issues in our code, but they are also able to propose solutions, thanks to accompanying code fixes. There&rsquo;s one more, less-advertised aspect of analyzers: besides improving the quality of our codebase, they also improve the state of language knowledge in our teams. <strong>This is a real time-saver during the code review because the technical, language-related remarks are reported automatically in design/build time</strong>. There are many existing analyzer packages provided by the community (mostly free and open-source) with hundreds of different rules. This abundance raises the following question: <strong>Which analyzer packages should I use and which rules should be reported as errors?</strong> To help answer this question, I decided to start a blog post series that describes different code smells together with analyzers that can detect them. I will start with analyzers related to asynchronous programming. However, this area is full of traps, so this article is the first of two episodes devoted to async/await.</p>
<h2 id="analyzers-for-asynchronous-programming">Analyzers for asynchronous programming<a href="#analyzers-for-asynchronous-programming" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h2>
<p>If you are looking for analyzers that can help you detect different issues with asynchronous code, you can find them in the following packages:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Microsoft.CodeAnalysis.FxCopAnalyzers/">Microsoft.CodeAnalysis.FxCopAnalyzers</a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.VisualStudio.Threading.Analyzers/">Microsoft.VisualStudio.Threading.Analyzers</a></li>
<li><a href="https://www.nuget.org/packages/AsyncFixer">AsyncFixer</a></li>
<li><a href="https://www.nuget.org/packages/Roslyn.Analyzers/">Roslyn.Analyzers</a></li>
<li><a href="https://www.nuget.org/packages/Meziantou.Analyzer/">Meziantou.Analyzer</a></li>
<li><a href="https://www.nuget.org/packages/Roslynator.Analyzers/">Roslynator</a></li>
<li><a href="https://www.nuget.org/packages/Asyncify/">Asyncify</a></li>
</ul>
<p>Most of those packages are not exclusively devoted to asynchronous programming, so I made an exercise by going through the complete list of offered rules and listed only those related to async code in the following sections:</p>
<div class="tab custom-tabs" role="tabpanel">
	<ul class="nav nav-tabs" role="tablist">

		
		

		
		
		

		
		<li role="presentation" class="active">
			<a data-toggle="tab" href="#tab11" role="tab" aria-controls="nav-home" aria-selected="true">FxCopAnalyzers</a>
		</li>
		
		

		
		
		

		
		<li>
			<a data-toggle="tab" href="#tab12" role="tab" aria-controls="nav-home" aria-selected="false">VS-Threading</a>
		</li>
		
		

		
		
		

		
		<li>
			<a data-toggle="tab" href="#tab13" role="tab" aria-controls="nav-home" aria-selected="false">AsyncFixer</a>
		</li>
		
		

		
		
		

		
		<li>
			<a data-toggle="tab" href="#tab14" role="tab" aria-controls="nav-home" aria-selected="false">Roslyn.Analyzers</a>
		</li>
		
		

		
		
		

		
		<li>
			<a data-toggle="tab" href="#tab15" role="tab" aria-controls="nav-home" aria-selected="false">Meziantou.Analyzer</a>
		</li>
		
		

		
		
		

		
		<li>
			<a data-toggle="tab" href="#tab16" role="tab" aria-controls="nav-home" aria-selected="false">Roslynator</a>
		</li>
		
		

		
		
		

		
		<li>
			<a data-toggle="tab" href="#tab17" role="tab" aria-controls="nav-home" aria-selected="false">Asyncify</a>
		</li>
		
		

	</ul>

	<div class="tab-content">

	






<div class="tab-pane active" id="tab11" role="tabpanel" aria-labelledby="nav-tabName1">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/visualstudio/code-quality/ca2007">CA2007</a></td>
<td>Consider calling ConfigureAwait on the awaited task</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/visualstudio/code-quality/ca2008">CA2008</a></td>
<td>Do not create tasks without passing a TaskScheduler</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/visualstudio/code-quality/ca2012">CA2012</a></td>
<td>Use ValueTasks correctly</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/visualstudio/code-quality/ca2247">CA2247</a></td>
<td>Argument passed to TaskCompletionSource constructor should be TaskCreationOptions enum instead of TaskContinuationOptions enum</td>
<td>Warning</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://github.com/dotnet/roslyn-analyzers/blob/master/src/Microsoft.CodeAnalysis.FxCopAnalyzers/Microsoft.CodeAnalysis.FxCopAnalyzers.md">Full list of supported rules</a></p>
<p>üëâ <a href="https://www.nuget.org/packages/Microsoft.CodeAnalysis.FxCopAnalyzers/">Nuget package</a></p>
<p>üëâ <a href="https://github.com/dotnet/roslyn-analyzers#microsoftcodeanalysisfxcopanalyzers">Official website</a></p>


</div>









<div class="tab-pane" id="tab12" role="tabpanel" aria-labelledby="nav-tabName2">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD001.md">VSTHRD001</a></td>
<td>Avoid legacy thread switching methods</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD002.md">VSTHRD002</a></td>
<td>Avoid problematic synchronous waits</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD003.md">VSTHRD003</a></td>
<td>Avoid awaiting foreign Tasks</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD004.md">VSTHRD004</a></td>
<td>Await SwitchToMainThreadAsync</td>
<td>Error</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD010.md">VSTHRD010</a></td>
<td>Invoke single-threaded types on Main thread</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD011.md">VSTHRD011</a></td>
<td>Use <code>AsyncLazy&lt;T&gt;</code></td>
<td>Error</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD012.md">VSTHRD012</a></td>
<td>Provide JoinableTaskFactory where allowed</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD100.md">VSTHRD100</a></td>
<td>Avoid <code>async void</code> methods</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD101.md">VSTHRD101</a></td>
<td>Avoid unsupported async delegates</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD102.md">VSTHRD102</a></td>
<td>Implement internal logic asynchronously</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD103.md">VSTHRD103</a></td>
<td>Call async methods when in an async method</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD104.md">VSTHRD104</a></td>
<td>Offer async option</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD105.md">VSTHRD105</a></td>
<td>Avoid method overloads that assume <code>TaskScheduler.Current</code></td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD106.md">VSTHRD106</a></td>
<td>Use <code>InvokeAsync</code> to raise async events</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD107.md">VSTHRD107</a></td>
<td>Await Task within using expression</td>
<td>Error</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD108.md">VSTHRD108</a></td>
<td>Assert thread affinity unconditionally</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD109.md">VSTHRD109</a></td>
<td>Switch instead of assert in async methods</td>
<td>Error</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD110.md">VSTHRD110</a></td>
<td>Observe result of async calls</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD111.md">VSTHRD111</a></td>
<td>Use <code>.ConfigureAwait(bool)</code></td>
<td>Hidden</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD112.md">VSTHRD112</a></td>
<td>Implement <code>System.IAsyncDisposable</code></td>
<td>Info</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD113.md">VSTHRD113</a></td>
<td>Check for <code>System.IAsyncDisposable</code></td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD114.md">VSTHRD114</a></td>
<td>Avoid returning null from a <code>Task</code>-returning method.</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/VSTHRD200.md">VSTHRD200</a></td>
<td>Use <code>Async</code> naming convention</td>
<td>Warning</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://github.com/microsoft/vs-threading/blob/master/doc/analyzers/index.md">Full list of supported rules</a></p>
<p>üëâ <a href="https://www.nuget.org/packages/Microsoft.VisualStudio.Threading.Analyzers/">Nuget package</a></p>
<p>üëâ <a href="https://github.com/microsoft/vs-threading">Official website</a></p>


</div>









<div class="tab-pane" id="tab13" role="tabpanel" aria-labelledby="nav-tabName3">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td>AsyncFixer01</td>
<td>Unnecessary async/await usage</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td>AsyncFixer02</td>
<td>Long-running or blocking operations inside an async method</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td>AsyncFixer03</td>
<td>Fire &amp; forget async void methods</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td>AsyncFixer04</td>
<td>Fire &amp; forget async call inside a using block</td>
<td>Warning</td>
<td>No</td>
</tr>
<tr>
<td>AsyncFixer05</td>
<td>Downcasting from a nested task to an outer task</td>
<td>Warning</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://www.nuget.org/packages/AsyncFixer">Full list of supported rules</a></p>
<p>üëâ <a href="https://www.nuget.org/packages/AsyncFixer">Nuget package</a></p>
<p>üëâ <a href="http://www.asyncfixer.com/">Official website</a></p>


</div>









<div class="tab-pane" id="tab14" role="tabpanel" aria-labelledby="nav-tabName4">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://roslyn-analyzers.readthedocs.io/en/latest/analyzers-info/async/async-method-names-should-be-suffixed-with-async.html#async-method-names-should-be-suffixed-with-async">ASYNC0001</a></td>
<td>Asynchronous method names should end with Async</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://roslyn-analyzers.readthedocs.io/en/latest/analyzers-info/async/non-async-method-names-should-not-be-suffixed-with-async.html#non-async-method-names-should-not-be-suffixed-with-async">ASYNC0002</a></td>
<td>Non asynchronous method names shouldn&rsquo;t end with Async</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://roslyn-analyzers.readthedocs.io/en/latest/analyzers-info/async/avoid-async-void-methods.html#avoid-async-void-methods">ASYNC0003</a></td>
<td>Avoid void returning asynchronous method</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://roslyn-analyzers.readthedocs.io/en/latest/analyzers-info/async/use-configure-await-false.html#use-configure-await-false">ASYNC0004</a></td>
<td>Use ConfigureAwait(false) on await expression</td>
<td>Warning</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://roslyn-analyzers.readthedocs.io/en/latest/repository.html#analyzers-in-the-repository">Full list of supported rules</a></p>
<p>üëâ <a href="https://www.nuget.org/packages/Roslyn.Analyzers/">Nuget package</a></p>
<p>üëâ <a href="https://roslyn-analyzers.readthedocs.io/">Official website</a></p>


</div>









<div class="tab-pane" id="tab15" role="tabpanel" aria-labelledby="nav-tabName5">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0004.md">MA0004</a></td>
<td>Use .ConfigureAwait(false)</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0022.md">MA0022</a></td>
<td>Return Task.FromResult instead of returning null</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0032.md">MA0032</a></td>
<td>Use an overload that have cancellation token</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0040.md">MA0040</a></td>
<td>Flow the cancellation token when available</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0042.md">MA0042</a></td>
<td>Do not use blocking cal</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0045.md">MA0045</a></td>
<td>Do not use blocking call (make method async)</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0079.md">MA0079</a></td>
<td>Flow a cancellation token using .WithCancellation()</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/meziantou/Meziantou.Analyzer/blob/master/docs/Rules/MA0080.md">MA0080</a></td>
<td>Specify a cancellation token using .WithCancellation()</td>
<td>Info</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://github.com/meziantou/Meziantou.Analyzer/tree/master/docs">Full list of supported rules</a></p>
<p>üëâ <a href="https://www.nuget.org/packages/Meziantou.Analyzer/">Nuget package</a></p>
<p>üëâ <a href="https://www.meziantou.net/enforcing-asynchronous-code-good-practices-using-a-roslyn-analyzer.htm">Official website</a></p>


</div>









<div class="tab-pane" id="tab16" role="tabpanel" aria-labelledby="nav-tabName6">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/JosefPihrt/Roslynator/blob/master/docs/analyzers/RCS1046.md">RCS1046</a></td>
<td>Asynchronous method name should end with &lsquo;Async&rsquo;</td>
<td>None</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/JosefPihrt/Roslynator/blob/master/docs/analyzers/RCS1047.md">RCS1047</a></td>
<td>Non-asynchronous method name should not end with &lsquo;Async&rsquo;</td>
<td>Info</td>
<td>No</td>
</tr>
<tr>
<td><a href="https://github.com/JosefPihrt/Roslynator/blob/master/docs/analyzers/RCS1090.md">RCS1090</a></td>
<td>Call &lsquo;ConfigureAwait(false)&rsquo;</td>
<td>Info</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/JosefPihrt/Roslynator/blob/master/docs/analyzers/RCS1174.md">RCS1174</a></td>
<td>Remove redundant async/await</td>
<td>None</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/JosefPihrt/Roslynator/blob/master/docs/analyzers/RCS1210.md">RCS1210</a></td>
<td>Return Task.FromResult instead of returning null</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="https://github.com/JosefPihrt/Roslynator/blob/master/docs/analyzers/RCS1229.md">RCS1229</a></td>
<td>Use async/await when necessary</td>
<td>Info</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://github.com/JosefPihrt/Roslynator/blob/master/src/Analyzers/README.md">Full list of supported rules</a></p>
<p>üëâ <a href="https://www.nuget.org/packages/Roslynator.Analyzers/">Nuget package</a></p>
<p>üëâ <a href="https://github.com/JosefPihrt/Roslynator">Official website</a></p>


</div>









<div class="tab-pane" id="tab17" role="tabpanel" aria-labelledby="nav-tabName7">

	<table>
<thead>
<tr>
<th>Id</th>
<th>Description</th>
<th>Default Severity</th>
<th>CodeFix</th>
</tr>
</thead>
<tbody>
<tr>
<td>AsyncifyInvocation</td>
<td>This invocation could benefit from the use of Task async.</td>
<td>Warning</td>
<td>Yes</td>
</tr>
<tr>
<td>AsyncifyVariable</td>
<td>This variable access could benefit from the use of Task async.</td>
<td>Warning</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>üëâ <a href="https://www.nuget.org/packages/Asyncify/">Nuget package</a></p>
<p>üëâ <a href="https://github.com/hvanbakel/Asyncify-CSharp">Official website</a></p>


</div>





	</div>
</div>
<h2 id="async-code-smells">Async Code Smells<a href="#async-code-smells" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h2>
<p>Here&rsquo;s my list of the first seven most common issues related to asynchronous programming. For every issue, I provide entries for <code>.editorconfig</code> that configure analyzers that can detect it.</p>
<h3 id="1-redundant-asyncawait">1. Redundant async/await<a href="#1-redundant-asyncawait" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p>Using the <code>async/await</code> keywords results in implicit memory allocation required for the state machine responsible for orchestrating asynchronous invocations. When the awaited expression is the only one or the last statement in the function, it might be skipped. However, there&rsquo;s a couple of concerns around this code optimization of which you should be aware. Before you start applying it, I highly recommend reading an excellent blog post about it from Stephen Cleary <a href="https://blog.stephencleary.com/2016/12/eliding-async-await.html">Eliding Async and Await</a>.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">async Task DoSomethingAsync()
{
    await Task.Yield(); //Reported diagnostics: AsyncFixer01, RCS1174
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">Task DoSomethingAsync()
{
    return Task.Yield();
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># AsyncFixer01: Unnecessary async/await usage
dotnet_diagnostic.AsyncFixer01.severity = error

# RCS1174: Remove redundant async/await.
dotnet_diagnostic.RCS1174.severity = error
</code></pre>
<h3 id="2-calling-synchronous-method-inside-the-async-method">2. Calling synchronous method inside the async method<a href="#2-calling-synchronous-method-inside-the-async-method" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p>If we are writing asynchronous code then we should always prefer calling asynchronous methods if they exist. Many IO related APIs offer asynchronous counterparts of their well known synchronous methods. They should be our first choice.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">async Task DoAsync(Stream file, byte[] buffer)
{
    file.Read(buffer, 0, 10); // VSTHRD103 is reported to use ReadAsync
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">async Task DoAsync(Stream file, byte[] buffer)
{
    await file.ReadAsync(buffer, 0, 10); // VSTHRD103 is reported to use ReadAsync
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># AsyncFixer02: Long-running or blocking operations inside an async method
dotnet_diagnostic.AsyncFixer02.severity = error

# NOTE: Not working when method is async
# VSTHRD103: Call async methods when in an async method
dotnet_diagnostic.VSTHRD103.severity = error
</code></pre>
<h3 id="3-async-void-method">3. Async Void method<a href="#3-async-void-method" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p>There are two reasons why Async Void methods are harmful:</p>
<ul>
<li>A caller of the method is not able to await asynchronous operation.</li>
<li>There&rsquo;s no way to handle exception thrown by the method. <strong>If the exception occurs, your process crashes!!!</strong></li>
</ul>
<p>You should always use <code>async Task</code> instead of <code>async void</code>, unless it&rsquo;s an event handler, but then you should guarantee yourself that the method can&rsquo;t throw an exception.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">async void DoSomethingAsync() // Reported diagnostics: VSTHRD100, AsyncFixer03, ASYNC0003
{
    await Task.Yield();
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">async Task DoSomethingAsync()
{
    await Task.Yield();
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># AsyncFixer03: Fire &amp; forget async void methods
dotnet_diagnostic.AsyncFixer03.severity = error

# VSTHRD100: Avoid async void methods
dotnet_diagnostic.VSTHRD100.severity = error

# ASYNC0003: Avoid void returning asynchronous method
dotnet_diagnostic.ASYNC0003.severity = error
</code></pre>
<h3 id="4-unsupported-async-delegates">4. Unsupported async delegates<a href="#4-unsupported-async-delegates" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p>If we pass the asynchronous lambda function the <code>Action</code> argument, the compiler generates <code>async void</code> method which downsides were described in the previous code smell. There are two solutions for this problem: if it&rsquo;s possible, we should change the parameter type from <code>Action</code> to <code>Func&lt;Task&gt;</code>, otherwise we need to implement that callback delegate synchronously. It&rsquo;s worth mentioning that some APIs already provide counterparts of their methods that accept <code>Func&lt;Task&gt;</code> for the callback parameters.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">void DoSomething()
{ 
    Callback(async () =&gt; // Reported diagnostics: VSTHRD101
    {
        await Task.Yield();
    });
}

void Callback(Action action)
{
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">void DoSomething()
{  
    CallbackAsync(async () =&gt;
    {
        await Task.Yield();
    });
}

void CallbackAsync(Func&lt;Task&gt; action)
{
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># VSTHRD101: Avoid unsupported async delegates
dotnet_diagnostic.VSTHRD101.severity = error
</code></pre>
<h3 id="5-not-awaited-task-within-using-expression">5. Not awaited Task within using expression<a href="#5-not-awaited-task-within-using-expression" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p><code>System.Threading.Tasks.Task</code> implements <code>IDisposable</code> interface. Calling a method returning task directly in <code>using</code> expressions results in <code>Task</code> disposal at the end of <code>using</code> block which is never an expected behavior.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">using (CreateDisposableAsync()) //Reported diagnostics: VSTHRD107
{
    
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">using (await CreateDisposableAsync())
{
    
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># VSTHRD107: Await Task within using expression
dotnet_diagnostic.VSTHRD107.severity = error
</code></pre>
<h3 id="6-not-awaited-task-inside-the-using-block">6. Not awaited Task inside the using block<a href="#6-not-awaited-task-inside-the-using-block" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p>If we skip the <code>await</code> keyword for asynchronous operation inside the <code>using</code> block, then the disposable object could be disposed before the asynchronous invocation finishes. This might result in incorrect behavior and very often ends with a runtime exception notifying that we are trying to operate on the object that is already disposed. This issue has two root causes: either it&rsquo;s done by accident when somebody simply forgot about adding <code>async/await</code> keywords or it&rsquo;s a result of incorrectly applied code optimization described in <code>Redundant async/await</code> code smell.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">private Task&lt;int&gt; DoSomething() // Reported diagnostics: RCS1229
{
    using (var service = CreateService())
    {
        return service.GetAsync(); // Reported diagnostics: AsyncFixer04
    }
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">private async Task&lt;int&gt; DoSomething()
{
    using (var service = CreateService())
    {
        return await service.GetAsync();
    }
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># AsyncFixer04: Fire &amp; forget async call inside a using block
dotnet_diagnostic.AsyncFixer04.severity = error

# RCS1229: Use async/await when necessary.
dotnet_diagnostic.RCS1229.severity = error
</code></pre>
<p>There is a small difference between those two analyzers. <code>RCS1229</code> is reported on the method level and <code>AsyncFixer04</code> is reported in the return statement line which is IMHO more intuitive. I also observed that those diagnostics are not able to report the issue while using a new <code>using var</code> syntax:</p>
<pre><code class="language-cs">private Task&lt;int&gt; DoSomething(CancellationToken cancellationToken)
{
    using var service = CreateService();
    return service.GetAsync(cancellationToken); // THIS SHOULD BE REPORTED!!!
}
</code></pre>
<p>In <code>Roslynator</code> this problem has been recently fixed <a href="https://github.com/JosefPihrt/Roslynator/issues/726">issues/726</a> (it&rsquo;s not released yet at the moment of publishing this article).</p>
<h3 id="7-unobserved-result-of-asynchronous-method">7. Unobserved result of asynchronous method<a href="#7-unobserved-result-of-asynchronous-method" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h3>
<p>Missing <code>await</code> keyword before asynchronous operation will result in method completing before given async operation finishes. The method will behave non-deterministically and the outcome will be different from the expectations. What is worse, if the un-awaited expression throws an exception, it goes unnoticed and it doesn&rsquo;t cause the process to crash, which makes it even harder to spot. You should always await asynchronous expression or assign a returned task to a variable and ensure that finally something awaits it.</p>
<p>‚ùå Wrong</p>
<pre><code class="language-cs">async Task DoSomethingAsync()
{
    await DoSomethingAsync1(); 
    DoSomethingAsync2(); // Reported diagnostics: CS4014, VSTHRD110
    await DoSomethingAsync3(); 
}
</code></pre>
<p>‚úîÔ∏è Correct</p>
<pre><code class="language-cs">async Task DoSomethingAsync()
{
    await DoSomethingAsync1(); 
    await DoSomethingAsync2();
    await DoSomethingAsync3();
}
</code></pre>
<p>üõ†Ô∏è Configuration</p>
<pre><code># VSTHRD110: Observe result of async calls
dotnet_diagnostic.VSTHRD110.severity = error

# CS4014: Because this call is not awaited, execution of the current method continues before the call is completed
dotnet_diagnostic.CS4014.severity = error
</code></pre>
<p>There&rsquo;s also a standard compiler warning <code>CS4014</code> for that issue but it&rsquo;s only able to report un-awaited expressions inside the <code>async</code> methods.</p>
<h2 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor"> üîó&#xFE0E;</a> </h2>
<table>
<thead>
<tr>
<th align="right">#</th>
<th>Code smell</th>
<th>AsyncFixer</th>
<th>VS-Threading</th>
<th>Roslyn.Analyzers</th>
<th>Roslynator</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">1.</td>
<td>Unnecessary async/await usage</td>
<td>üîéüõ†Ô∏è  AsyncFixer01</td>
<td></td>
<td></td>
<td>üîéüõ†Ô∏è  RCS1174</td>
</tr>
<tr>
<td align="right">2.</td>
<td>Call sync methods inside async method</td>
<td>üîéüõ†Ô∏è  AsyncFixer02</td>
<td>üîéüõ†Ô∏è VSTHRD103</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="right">3.</td>
<td>Async void methods</td>
<td>üîéüõ†Ô∏è AsyncFixer03</td>
<td>üîéüõ†Ô∏è VSTHRD100</td>
<td>üîéüõ†Ô∏è  ASYNC0003</td>
<td></td>
</tr>
<tr>
<td align="right">4.</td>
<td>Unsupported async delegates</td>
<td></td>
<td>üîé VSTHRD101</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="right">5.</td>
<td>Not awaited Task within using expression</td>
<td></td>
<td>üîéüõ†Ô∏è VSTHRD107</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="right">6.</td>
<td>Not awaited Task inside the using block</td>
<td>üîé AsyncFixer04</td>
<td></td>
<td></td>
<td>üîéüõ†Ô∏è RCS1229</td>
</tr>
<tr>
<td align="right">7.</td>
<td>Unobserved result of asynchronous method</td>
<td></td>
<td>üîé VSTHRD110</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>üîé - Analyzer</p>
<p>üõ†Ô∏è - CodeFix</p>
    
		
		<hr/>  
		<p>If you find this blog post useful and you think it's worth to share this idea with others, <strong>please don't hesitate to use these buttons below</strong> üëá</p>	
		<div class="addthis_inline_share_toolbox"></div>
		
	</article>
	
	
	<h3>See Also</h3>
	<div class="row">
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/async-analyzers-p2/" >
						<div class="card">
								<img class="card-img-top" src="../../post/async-analyzers-p2/splashscreen_hu73bdedc1b07de211d2ee5d014a251d3c_195136_320x240_fill_q75_box_smart1.jpg" alt="Async code smells and how to track them down with analyzers - Part II">
								<div class="card-body">
									<h5 class="card-title">Async code smells and how to track them down with analyzers - Part II</h5>											  
								</div>
							</div></a>
				</div>		
			
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/better-non-nullable-handling/" >
						<div class="card">
								<img class="card-img-top" src="../../post/better-non-nullable-handling/splashscreen_hua2a5c0e1b25e36f0314c2d7b21c3fd45_140846_320x240_fill_q75_box_smart1.jpg" alt="Improving non-nullable reference types handling">
								<div class="card-body">
									<h5 class="card-title">Improving non-nullable reference types handling</h5>											  
								</div>
							</div></a>
				</div>		
			
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/methods-with-special-signature/" >
						<div class="card">
								<img class="card-img-top" src="../../post/methods-with-special-signature/splashscreen_huad0994e5edc03298d344367c5114e98c_58460_320x240_fill_q75_box_smart1.jpg" alt="The Magical Methods in C#">
								<div class="card-body">
									<h5 class="card-title">The Magical Methods in C#</h5>											  
								</div>
							</div></a>
				</div>		
			
		
	</div>
	<br />
	
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" https://cezarypiatek.github.io/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>
  
	
	  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "cezarypiatek-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	

						  </div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
     if (window.location.hostname === "localhost") {
		console.log("Analytics not running on local dev.");		
	}else{
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-18735584-9', 'auto');
		ga('send', 'pageview');
		window.baseURL = "https:\/\/cezarypiatek.github.io\/";
	}
  </script>
  

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/story-show-gallery@2/dist/ssg.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
		
  
  <script src="../../lib/gifplayer/jquery.gifplayer.js"></script>
  <script>
	   $(document).ready(function(){   
		$("img[src$='_animated.png']").gifplayer({
			label: "‚ñ∂"
		});
	  });
  </script>
  <script src="https://cezarypiatek.github.io//js/App.js"></script>
  
  <script type="text/javascript">
	var addthis_share = addthis_share || {}
	addthis_share = {
		passthrough : {
			twitter: {
				via: "cezary_piatek",
				hashtags: "dotnet,csharp,async,roslyn,analyzers"
			}
		}
	}
	</script> 
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a286b9b1c027c15" async></script>
  
    
	<script src="//cdn.rawgit.com/mburakerman/prognroll/master/src/prognroll.js"></script>
	<script>
		$(function() {
		  $("#content").prognroll({
				height: 5,
				custom: true
  			});
		});
	</script>

</body>
</html>
