<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">   
	<meta name="theme-color" content="#ffffff">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="A couple of tricks which simplify database access code while using Dapper library">   
    <script type="application/ld+json">
        {
          "@context" : "http://schema.org",
          "@type": "BlogPosting",
            "mainEntityOfPage":{
            "@type":"WebPage",
            "@id":"https:\/\/cezarypiatek.github.io\/post\/dapper-tips-and-tricks\/"
            },
          "headline" : "Working efficiently with legacy database using Dapper",
          "author" : {
            "@type" : "Person",
            "name" : "CEZARY PIÄ„TEK"
          },
          "publisher" : {
            "@type" : "Person",
            "name" : "CEZARY PIÄ„TEK"
          },
          "datePublished" : "2020-08-02",
          "dateModified" : "2020-08-02",
          "image" : "https:\/\/cezarypiatek.github.io\/post\/dapper-tips-and-tricks\/splashscreen.jpg",
          "description": "A couple of tricks which simplify database access code while using Dapper library"
        }
        </script>
        
    <meta property="article:published_time" content="2020-08-02">
	<meta property="og:type" content="article">
    
	<meta property="og:locale" content="en_US">	
	<meta property="og:url" content="https://cezarypiatek.github.io/post/dapper-tips-and-tricks/">	
	<meta property="og:title" content="Working efficiently with legacy database using Dapper">
	<meta property="og:image" content="https://cezarypiatek.github.io/post/dapper-tips-and-tricks/splashscreen.jpg">
    <meta property="og:description" content="A couple of tricks which simplify database access code while using Dapper library">
    <meta property="og:site_name" content="Cezary PiÄ…tek Blog">
    
    <meta property="og:tags" content="Dapper">
    
    <meta property="og:tags" content="SqlServer">
    
    <meta property="og:tags" content="C#">
    
    <meta property="og:tags" content="dotnet">
    
	<meta property="twitter:card" content="summary_large_image" >
	<meta property="twitter:image" content="https://cezarypiatek.github.io/post/dapper-tips-and-tricks/splashscreen.jpg">
	<meta property="twitter:title" content="Working efficiently with legacy database using Dapper">	
	<meta property="twitter:creator" content="@cezary_piatek">
	<meta property="twitter:description" content="A couple of tricks which simplify database access code while using Dapper library">

	<meta name="keywords" value="Dapper, SqlServer, C#, dotnet" />
    <meta name="generator" content="Hugo 0.74.3" />
    <title>Working efficiently with legacy database using Dapper &middot; Cezary PiÄ…tek Blog</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/a11y-dark.min.css">
    
    <link rel="stylesheet" href="https://cezarypiatek.github.io/css/style.css">
    <link rel="stylesheet" href="https://cezarypiatek.github.io/lib/gifplayer/gifplayer.css">
    
    <link href="https://cezarypiatek.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Cezary PiÄ…tek Blog" />
        
	<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
	<link rel="manifest" href="../../manifest.json">
  <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/story-show-gallery@2/dist/ssg.min.css">
    
    
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="https://cezarypiatek.github.io/">CEZARY PIÄ„TEK</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="https://cezarypiatek.github.io/">Blog</a></li>
				
					<li><a href="https://cezarypiatek.github.io/projects/">Projects</a></li>
				
					<li><a href="https://cezarypiatek.github.io/public-speaking/">Public speaking</a></li>
				
					<li><a href="https://cezarypiatek.github.io/about/">About me</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="https://cezarypiatek.github.io/">CEZARY PIÄ„TEK</a></h1>
		
		
		
			<small class="text-center center-block">Natural born software developer</small>
		
		
		
			<img id="profile-pic" src="https://cezarypiatek.github.io//images/7759991.jpg" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			
				<a href="https://github.com/cezarypiatek" title="Check my Open Source works"><i class="fa fa-github fa-2x"></i></a>
			
				<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fpublish.twitter.com%2F%3FbuttonType%3DFollowButton%26query%3D%2540cezary_piatek%26widget%3DButton&amp;ref_src=twsrc%5Etfw&amp;region=follow_link&amp;screen_name=cezary_piatek&amp;tw_p=followbutton" title="Follow me on Twitter"><i class="fa fa-twitter fa-2x"></i></a>
			
				<a href="https://www.linkedin.com/in/cezary-pi%C4%85tek-373737185/" title="Follow me on LinkedIn"><i class="fa fa-linkedin fa-2x"></i></a>
			
				<a href="https://stackoverflow.com/users/876060/cezarypiatek" title="Check my StackOverflow profile"><i class="fa fa-stack-overflow fa-2x"></i></a>
			
				<a href="../../index.xml" title="Be up to date - subscribe to my rss feed channel"><i class="fa fa-rss fa-2x"></i></a>
			

			
		</div>
		<div id="links" class="text-center">
			
			
				<a href="https://cezarypiatek.github.io/">Blog</a>
			
				<a href="https://cezarypiatek.github.io/projects/">Projects</a>
			
				<a href="https://cezarypiatek.github.io/public-speaking/">Public speaking</a>
			
				<a href="https://cezarypiatek.github.io/about/">About me</a>
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8 ssg">

<main>
	<article>
		<header>
			<h1>Working efficiently with legacy database using Dapper</h1>
			  
			<div><i class="fa fa-calendar"></i> <time>2 August 2020</time></div>
			<hr />
			
		</header>
		
			<img src="splashscreen.jpg" width="100%" />
			<br />
		
		<p>A year ago I started working on a set of projects that requires accessing data from a huge legacy database. There was a decision to use <a href="https://github.com/StackExchange/Dapper">Dapper</a> to facilitate database access code. For those of you who are not familiar with Dapper, it&rsquo;s a set of extension methods to <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.idbconnection?view=netcore-3.1">IDbConnection</a>, which allows to easily map C# object to SQL query parameters, as well as SQL query result to C# objects. I was quite skeptical to use a library that requires writing <code>SQL queries</code> directly in the C# code, because I got used to relying always on ORMs (<code>NHibernate</code> in particular). Throughout the year, <code>Dapper</code> has proven to be the right tool for the job. In the meantime, I also discovered a couple of features and tricks that allow me to write quite concise and easy to maintain database access code, and I think it&rsquo;s worth sharing them here.</p>
<blockquote>
<p>Key Takeaways:</p>
<ul>
<li>Always define aliases in SQL queries using <code>nameof()</code> operator</li>
<li>Use C# consts and enums in SQL queries instead of magic numbers</li>
<li>Use <code>FOR JSON PATH</code> to simplify fetching complex objects from database</li>
</ul>
</blockquote>
<h2 id="resilient-to-refactoring">Resilient to refactoring<a href="#resilient-to-refactoring" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>Dapper allows to easily map SQL query results to C# objects based on the naming convention. There&rsquo;s no problem if the database table columns&rsquo; names match object fields&rsquo; name - if there&rsquo;s a discrepancy, you can deal with it by adding aliases:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> 
    UserID <span style="color:#66d9ef">AS</span> [Id], 
    UserName <span style="color:#66d9ef">AS</span> [Name]
<span style="color:#66d9ef">FROM</span> 
    Users
</code></pre></div><p>However, the naming convention approach is fragile to rename refactoring. Changing the object field&rsquo;s name will break your code and it can be hard to detect without an appropriate test suite. Fortunately, there&rsquo;s a way to shorten this feedback loop and solve this issue in the design time. We can make our code more resilient by defining aliases using <code>string interpolation</code> and <code>nameof()</code> operator:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetUsersListQuery = <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">$&#34;
</span><span style="color:#e6db74">SELECT 
</span><span style="color:#e6db74">    UserID AS [{nameof(UserDBO.Id)}], 
</span><span style="color:#e6db74">    UserName AS [{nameof(UserDBO.Name)}]
</span><span style="color:#e6db74">FROM 
</span><span style="color:#e6db74">    Users
</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>This not only takes away the threat of breaking the code while renaming <code>DBO</code> fields but also gives better discoverability and navigability in the code. Using <code>find usage</code> option, we can also find where a given field is used in the SQL queries. And there&rsquo;s no performance penalty because the compiler can evaluate this string interpolation during the compilation, because all of the parameters are const. You can verify it by yourself with this <a href="https://sharplab.io/#v2:EYLgZgpghgLgrgJwgZwLQAdYwggdsgZgB8ABAJgEYBYAKHIAIBVZHAEQCEB5Wgb1voH0SBegEtcMegEkAJvR70A5hBgBueizX0Avv0HCxE+gDkoAWwjylK9ZvW6aD2gYYAlCOgD2yUTE8IAT3k9enQEUQA3WEsSCgA2eiQoGU9cABsg2IAGegBxFWYcZAAZUWQYAEU4HCCAXiESABIAIloAZQBRYo6AYQAVehCmFgQpVnoAQTb6AG0eXHMITzAACkKEDk4AOlkASm0AXQAaQZpBYZxTC0npuYWLZbWRza2riH2D2gAxV04AWVO53WyFozVUtG0QA">Sharplab.io example</a></p>
<p>But what if we want to get the result of the string interpolation without the need to run the whole program in debug mode? This is often needed when there&rsquo;s a bug in the query and we want to copy it and test in the <code>Management Studio</code>. This can be easily archived with <code>Immediate window</code> - yes, that&rsquo;s right, you can use <code>Immediate window</code> to evaluate the code in the design time. To evaluate the string, just enter fully qualified field name that holds the query into the <code>Immediate window</code>:</p>
<p>
<a href="evaluated_string_interpolation.jpg"><img  src="evaluated_string_interpolation.jpg" alt=""></a>
</p>
<p>Unfortunately, the output is not well-formatted and contains additional characters for line endings. We can fix it by adding <code>nq</code> (no quote) suffix:</p>
<p>
<a href="evaluated_string_interpolation_with_nq.jpg"><img  src="evaluated_string_interpolation_with_nq.jpg" alt=""></a>
</p>
<p>If you are using <code>Resharper</code> then you can avoid typing long <code>FQN</code> and copy it with a special option for this purpose:</p>
<p>
<a href="resharper_copy_FQN.jpg"><img  src="resharper_copy_FQN.jpg" alt=""></a>
</p>
<h2 id="no-magic-numbers">No magic numbers<a href="#no-magic-numbers" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>Sometimes there is a need to use some sort of constant values in the SQL query (especially in the conditions). Queries with those cryptic values are very hard to review or even can cause a problem with understanding for the author himself after a while:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Repository</span> {
   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetActiveUsersListQuery = <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">$&#34;
</span><span style="color:#e6db74">SELECT 
</span><span style="color:#e6db74">    UserID, 
</span><span style="color:#e6db74">    UserName
</span><span style="color:#e6db74">FROM 
</span><span style="color:#e6db74">    Users
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">    UserType = 135
</span><span style="color:#e6db74">&#34;</span>;
}
</code></pre></div><p>This is a classical example of well known code smell called <code>magic numbers</code>. We can solve this problem again with string interpolation. <strong>It&rsquo;s tempting to introduce an enum that represents a set of available values but unfortunately using an enum as a parameter for the interpolated string will prevent the compiler from evaluating expression during the compilation. The evaluation will occur in the runtime and will result in creating a new string in the memory whenever the code is executed.</strong> This can hurt the application performance especially when you define SQL queries as local variables. You can check it on this <a href="https://sharplab.io/#v2:EYLgZgpghgLgrgJwgZwLQAdYwggdsgZgB8ABAJgEYBYAKHIAIBVZHAEQCEB5Wgb1voH0SBegEtcMegEkAJvR70A5hBgBueizX0Avv0HCxE+gDkoAWwjylK9ZvW6ag+rQe0IuOGaYsEAFQCe6BC8egIAggDGMKIAbpYAvPQUBACsADSh0rhQUbEJSQQAbC60tAYMAEoQ6AD2yKIwNQj+8qHoCLGwliQUhfRIUDI1uAA2LT0ADPQA4irMOMgAMqLIMACKcDgtiSQkACQARLQAygCii6cAwr7OjoLzCFKsabdOD6YWtABiFZwAsq97j5kLQAOoACVOFVOmQeASC9ESPDhgQgADpItE4g4DqoXEA">Sharplab.io example</a> If you need to keep strings with SQL queries as local variables then it&rsquo;s better to define those magic values as const:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Repository</span> {
    
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserType</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> Active = <span style="color:#e6db74">&#34;135&#34;</span>;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> Inactive = <span style="color:#e6db74">&#34;136&#34;</span>;
    }
    
   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetActiveUsersListQuery = <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">$&#34;
</span><span style="color:#e6db74">SELECT 
</span><span style="color:#e6db74">    UserID, 
</span><span style="color:#e6db74">    UserName
</span><span style="color:#e6db74">FROM 
</span><span style="color:#e6db74">    Users
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">    UserType = {UserType.Active}
</span><span style="color:#e6db74">&#34;</span>;
}
</code></pre></div><p>Those constants must be a string type even if they are numeric values, otherwise the compiler generates invocation of <code>System.String.Format()</code> instead of creating a single string.</p>
<h2 id="bridge-the-gap-between-relational-and-object-oriented-models">Bridge the gap between relational and object-oriented models<a href="#bridge-the-gap-between-relational-and-object-oriented-models" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>Very often posts advertising micro ORMs present fairly simple examples where database data structures match almost 1-1 the C# structures. However, the reality is quite different and the discrepancy between relational and object-oriented model might be expensive and result with a large amount of code responsible for fetching and transforming data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id {<span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>;}
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> FirstName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> LastName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> Address MainAddress { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Address</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> City { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> ZipCode { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Street { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> FlatNo { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> BuildingNo { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>In order to fetch complete user data we can use one of the following approaches:</p>
<p>We can introduce some sort of intermediate type for fetching a result of the SQL query and then map it to the destination type in the memory. I call those intermediate types <code>DBO - DataBase Object</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserDBO</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id {<span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>;}
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> FirstName { <span style="color:#66d9ef">get</span>;  }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> LastName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> City { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> ZipCode { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Street { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> FlatNo { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> BuildingNo { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserRepository</span>
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetAllUserDataSqlQuery = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">/*TODO: Here comes query for fetching user basic data*/</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;User&gt; GetUser(IDbConnection connection, <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> userDBO = <span style="color:#66d9ef">await</span> connection.QueryFirstOrDefaultAsync&lt;UserDBO&gt;(GetAllUserDataSqlQuery, <span style="color:#66d9ef">new</span> {UserId = id});
        <span style="color:#66d9ef">if</span>(userDBO == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> User
        {
            Id = userDBO.Id,
            FirstName = userDBO.FirstName,
            LastName = userDBO.LastName,
            <span style="color:#75715e">//TODO: If the address is optional then we should check if all attributes are not empty before creating an instance of Address
</span><span style="color:#75715e"></span>            MainAddress = <span style="color:#66d9ef">new</span> Address
            {
                City = userDBO.City,
                ZipCode = userDBO.ZipCode,
                Street = userDBO.Street,
                FlatNo = userDBO.FlatNo,
                BuildingNo = userDBO.BuildingNo
            }
        };
    }
}
</code></pre></div><p>This solution has several disadvantages:</p>
<ul>
<li>It requires an intermediate DBO type.</li>
<li>It requires additional mapping code to adjust fetched data to the desired structure</li>
<li>If we change the relation between User and Address from one-to-one to one-to-many, it will result in data duplication.</li>
</ul>
<p>Another option is to fetch direct attributes (Id, FirstName, LastName) with one query, fetch address data with another one and merge user with address in memory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserRepository</span>
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetUserBasicDataSqlQuery = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">/*TODO: Here comes query for fetching user basic data*/</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetAddressDataSqlQuery = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">/*TODO: Here comes query for fetching address data*/</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;User&gt; GetUser(IDbConnection connection, <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> user = <span style="color:#66d9ef">await</span> connection.QueryFirstOrDefaultAsync&lt;User&gt;(GetUserBasicDataSqlQuery, <span style="color:#66d9ef">new</span> {UserId = id});
        <span style="color:#66d9ef">if</span>(user == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
        }
        user.MainAddress = <span style="color:#66d9ef">await</span> connection.QueryFirstOrDefaultAsync&lt;Address&gt;(GetAddressDataSqlQuery, <span style="color:#66d9ef">new</span> {UserId = id});
        <span style="color:#66d9ef">return</span> user;
    }
}
</code></pre></div><p>This approach requires two calls to a database, but it can be reduced by merging those two queries into a single string and executing it with <code>SqlMapper.GridReader</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserRepository</span>
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetUserBasicDataSqlQuery = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">/*TODO: Here comes query for fetching user basic data*/</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetAddressDataSqlQuery = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">/*TODO: Here comes query for fetching address data*/</span>

     <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> GetUserCompleteDataSqlQuery = <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">$&#34;
</span><span style="color:#e6db74">        -- Fetch user basic data
</span><span style="color:#e6db74">        {GetUserBasicDataSqlQuery};
</span><span style="color:#e6db74">        -- Fetch address data
</span><span style="color:#e6db74">        {GetAddressDataSqlQuery};
</span><span style="color:#e6db74">    &#34;</span>;    

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;User&gt; GetUser(IDbConnection connection, <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">using</span> var gridReader = <span style="color:#66d9ef">await</span> connection.QueryMultipleAsync(GetUserCompleteDataSqlQuery, <span style="color:#66d9ef">new</span> { UserId = id });
        <span style="color:#66d9ef">var</span> user = <span style="color:#66d9ef">await</span> gridReader.ReadFirstOrDefaultAsync&lt;User&gt;();
        <span style="color:#66d9ef">if</span> (user == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
        }

        user.MainAddress = <span style="color:#66d9ef">await</span> gridReader.ReadFirstOrDefaultAsync&lt;Address&gt;();
        <span style="color:#66d9ef">return</span> user;
    }
}
</code></pre></div><p>Looks like this solution is much cleaner and requires less code than the option with the intermediate DBO object, but things can get really messy when we want to fetch data for more than one user and the relation between user and address is one-to-many:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;IReadOnlyCollection&lt;User&gt;&gt; GetAllUsers(IDbConnection connection)
{
    <span style="color:#66d9ef">using</span> var gridReader = <span style="color:#66d9ef">await</span> connection.QueryMultipleAsync(GetUserCompleteDataSqlQuery);
    <span style="color:#66d9ef">var</span> users = (<span style="color:#66d9ef">await</span> gridReader.ReadAsync&lt;User&gt;()).ToList();
    <span style="color:#66d9ef">var</span> addresses =  <span style="color:#66d9ef">await</span> gridReader.ReadAsync&lt;Address&gt;();
    <span style="color:#75715e">//INFO: Address entity needs to be extended with UserId in order to merge the data correctly
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> addressesByUserId = addresses.GroupBy(x =&gt; x.UserId).ToDictionary(x =&gt; x.Key, x =&gt; x);
    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> user <span style="color:#66d9ef">in</span> users)
    {
        <span style="color:#66d9ef">if</span> (addressesByUserId.TryGetValue(user.Id, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">var</span> userAddresses))
        {
            user.Addresses = userAddresses.ToList();
        }
    }
    <span style="color:#66d9ef">return</span> users;
}
</code></pre></div><p>We can simplify it by taking leverage of JSON support in SQL Server. For the relation 1-1 between the <code>User</code> and <code>Address</code> our SQL query can look as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>
    u.UserId <span style="color:#66d9ef">AS</span> [Id],
    u.FirstName <span style="color:#66d9ef">AS</span> [FirstName],
    u.LastName <span style="color:#66d9ef">AS</span> [LastName]
    a.City <span style="color:#66d9ef">AS</span> [MainAddress.City],
    a.ZipCode <span style="color:#66d9ef">AS</span> [MainAddress.ZipCode],
    a.Street <span style="color:#66d9ef">AS</span> [MainAddress.Street],
    a.FlatNo <span style="color:#66d9ef">AS</span> [MainAddress.FlatNo],
    a.BuildingNo <span style="color:#66d9ef">AS</span> [MainAddress.BuildingNo],
<span style="color:#66d9ef">FROM</span>
    Users u 
    <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> Addresses a <span style="color:#66d9ef">ON</span> a.UserId <span style="color:#f92672">=</span> u.UserID
<span style="color:#66d9ef">FOR</span> JSON PATH
</code></pre></div><p>or we can rewrite it to handle one-to-many relation using sub-query:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>
    u.UserId <span style="color:#66d9ef">as</span> [Id],
    u.FirstName <span style="color:#66d9ef">as</span> [FirstName],
    u.LastName <span style="color:#66d9ef">as</span> [LastName]
    (
        <span style="color:#66d9ef">SELECT</span>
            a.City <span style="color:#66d9ef">AS</span> [City],
            a.ZipCode <span style="color:#66d9ef">AS</span> [ZipCode],
            a.Street <span style="color:#66d9ef">AS</span> [Street],
            a.FlatNo <span style="color:#66d9ef">AS</span> [FlatNo],
            a.BuildingNo <span style="color:#66d9ef">AS</span> [BuildingNo]
        <span style="color:#66d9ef">FROM</span> 
            Addresses a
        <span style="color:#66d9ef">WHERE</span>
            a.UserId <span style="color:#f92672">=</span> u.UserID
        <span style="color:#66d9ef">FOR</span> JSON PATH
    )  <span style="color:#66d9ef">AS</span> [Addresses]
<span style="color:#66d9ef">FROM</span>
    Users u 
</code></pre></div><p>But how can we fetch this JSON SQL query result using Dapper? The most common solution that we can come across on the internet is to create a custom type handler for our SQL query result:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JsonTypeHandler</span>&lt;TResult&gt;: SqlMapper.TypeHandler&lt;TResult&gt;
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> SetValue(IDbDataParameter parameter, TResult <span style="color:#66d9ef">value</span>) =&gt; 
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotSupportedException(<span style="color:#e6db74">$&#34;Sending &#39;{typeof(TResult).FullName}&#39; type to database is not supported&#34;</span>);

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> TResult Parse(<span style="color:#66d9ef">object</span> <span style="color:#66d9ef">value</span>)
    {
        <span style="color:#66d9ef">var</span> jsonPayload = <span style="color:#66d9ef">value</span>?.ToString();
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(jsonPayload))
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">default</span>;
        }
        <span style="color:#66d9ef">return</span> JsonConvert.DeserializeObject&lt;TResult&gt;(jsonPayload);
    }
}
</code></pre></div><p>After registering type handler with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs">SqlMapper.AddTypeHandler(<span style="color:#66d9ef">new</span> JsonTypeHandler&lt;User&gt;());
</code></pre></div><p>we can query our data with <code>Dapper</code> query extension methods as usual. However, this approach with custom type handler has two disadvantages:</p>
<ul>
<li>We need to register <code>JsonTypeHandler&lt;&gt;</code> for every most outer type which we are querying</li>
<li><strong>This won&rsquo;t work for larger objects</strong> because the SQL Server will split long JSON string across multiple rows. You can read more about that on MSDN in the section <a href="https://docs.microsoft.com/en-us/sql/relational-databases/json/format-query-results-as-json-with-for-json-sql-server?view=sql-server-ver15#output-of-the-for-json-clause">Output of the FOR JSON clause</a></li>
</ul>
<p>We can solve both problems by executing SQL queries with the following extension method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SqlQueryExtensions</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> Task&lt;TResult&gt; QueryFromJson&lt;TResult&gt;(<span style="color:#66d9ef">this</span> IDbConnection connection, <span style="color:#66d9ef">string</span> sqlQuery, <span style="color:#66d9ef">object</span> param)
    {
        <span style="color:#66d9ef">var</span> chunks = <span style="color:#66d9ef">await</span> connection.QueryAsync&lt;<span style="color:#66d9ef">string</span>&gt;(sqlQuery, param);
        <span style="color:#66d9ef">var</span> completeJsonPayload = <span style="color:#66d9ef">string</span>.Concat(chunks);
        <span style="color:#66d9ef">return</span> JsonConvert.DeserializeObject&lt;TResult&gt;(completeJsonPayload);
    }
}
</code></pre></div><p>With this JSON SQL query approach I was able to very easily fetch quite complex object from the database. The only limitation I came across was lack of ability to fetch properties which are a list of primitive times. SQL Server always wraps sub-queries result in the object, even if they are based on a single column.</p>
<p>As you might notice - in SQL queries formatted as a JSON it&rsquo;s possible to define aliases with a dot notation like <code>[MainAddress.City]</code>. Unfortunately, there&rsquo;s no operator in C# like <code>nameof</code> which could return full member path, but we can simulate that with the following method that accepts expression tree:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TypeExtensions</span>&lt;TType&gt;
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> MemberPath&lt;TMember&gt;(Expression&lt;Func&lt;TType, TMember&gt;&gt; member)
    {
        <span style="color:#66d9ef">var</span> expressionText = member.Body.ToString();
        <span style="color:#66d9ef">return</span> expressionText.Substring(expressionText.IndexOf(<span style="color:#e6db74">&#39;.&#39;</span>)+<span style="color:#ae81ff">1</span>);
    }
}
</code></pre></div><p>With this helper method we can rewrite our query to be resilient to refactoring in the following way:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserRepository</span>
{
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> Query = <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">$&#34;
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">    u.UserId AS [{nameof(User.Id)}],
</span><span style="color:#e6db74">    u.FirstName AS [{nameof(User.FirstName)}],
</span><span style="color:#e6db74">    u.LastName AS [{nameof(User.Id)}]
</span><span style="color:#e6db74">    a.City AS [{TypeExtensions&lt;User&gt;.MemberPath(x=&gt;x.MainAddress.City)}],
</span><span style="color:#e6db74">    a.ZipCode AS [{TypeExtensions&lt;User&gt;.MemberPath(x =&gt; x.MainAddress.ZipCode)}],
</span><span style="color:#e6db74">    a.Street AS [{TypeExtensions&lt;User&gt;.MemberPath(x =&gt; x.MainAddress.Street)}],
</span><span style="color:#e6db74">    a.FlatNo AS [{TypeExtensions&lt;User&gt;.MemberPath(x =&gt; x.MainAddress.FlatNo)}],
</span><span style="color:#e6db74">    a.BuildingNo AS [{TypeExtensions&lt;User&gt;.MemberPath(x =&gt; x.MainAddress.BuildingNo)}],
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">    Users u 
</span><span style="color:#e6db74">    LEFT JOIN Addresses a ON a.UserId = u.UserID
</span><span style="color:#e6db74">    WHERE  u.UserID = @UserId
</span><span style="color:#e6db74">FOR JSON PATH
</span><span style="color:#e6db74">&#34;</span>;
}
</code></pre></div><p>The necessity to provide <code>TypeExtensions&lt;User&gt;</code> for every <code>MemberPath</code> invocation can make our query a little noisy. This can be simplified with <code>using static</code> or by defining short alias for generic type. We also have to keep in mind that the invocation of <code>MemberPath</code> function is evaluated in the runtime.</p>
    
		
		<hr/>  
		<p>If you find this blog post useful and you think it's worth to share this idea with others, please don't hesitate to use these buttons below:</p>	
		<div class="addthis_inline_share_toolbox"></div>
		
	</article>
	
	
	<h3>See Also</h3>
	<div class="row">
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/generate-mappings-on-build/" >
						<div class="card">
								<img class="card-img-top" src="../../post/generate-mappings-on-build/splashscreen_hu831a556e644f698f06f7bab476f01bf6_99100_320x240_fill_q75_box_smart1.jpg" alt="How to simulate AutoMapper that works during the build time">
								<div class="card-body">
									<h5 class="card-title">How to simulate AutoMapper that works during the build time</h5>											  
								</div>
							</div></a>
				</div>		
			
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/exceptions-usages-analyzer/" >
						<div class="card">
								<img class="card-img-top" src="../../post/exceptions-usages-analyzer/splashscreen_hu4726010f8bf92c1a7527d07383ef14cb_95165_320x240_fill_q75_box_smart1.jpg" alt="Exception usage analyzer">
								<div class="card-body">
									<h5 class="card-title">Exception usage analyzer</h5>											  
								</div>
							</div></a>
				</div>		
			
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/renovate-your-dot-net-solution/" >
						<div class="card">
								<img class="card-img-top" src="../../post/renovate-your-dot-net-solution/splashscreen_hu0d8c53dcbc8a208d1870631c6fe44e6a_210085_320x240_fill_q75_box_smart1.jpg" alt="Renovate your .NET solution">
								<div class="card-body">
									<h5 class="card-title">Renovate your .NET solution</h5>											  
								</div>
							</div></a>
				</div>		
			
		
	</div>
	<br />
	
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" https://cezarypiatek.github.io/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>
  
	
	  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "cezarypiatek-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	

						  </div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
     if (window.location.hostname === "localhost") {
		console.log("Analytics not running on local dev.");		
	}else{
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-18735584-9', 'auto');
		ga('send', 'pageview');
		window.baseURL = "https:\/\/cezarypiatek.github.io\/";
	}
  </script>
  

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/story-show-gallery@2/dist/ssg.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
		
  
  <script src="../../lib/gifplayer/jquery.gifplayer.js"></script>
  <script>
	   $(document).ready(function(){   
		$("img[src$='_animated.png']").gifplayer({
			label: "â–¶"
		});
	  });
  </script>
  <script src="https://cezarypiatek.github.io//js/App.js"></script>
  
  <script type="text/javascript">
	var addthis_share = addthis_share || {}
	addthis_share = {
		passthrough : {
			twitter: {
				via: "cezary_piatek",
				hashtags: "Dapper,SqlServer,Csharp,dotnet"
			}
		}
	}
	</script> 
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a286b9b1c027c15" async></script>
  
    
	<script src="//cdn.rawgit.com/mburakerman/prognroll/master/src/prognroll.js"></script>
	<script>
		$(function() {
		  $("#content").prognroll({
    custom: true
  });
		});
	</script>

</body>
</html>
