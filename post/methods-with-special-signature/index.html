<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">   
	<meta name="theme-color" content="#ffffff">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="Methods with specific signature which have a special support in C#">   
    <script type="application/ld+json">
        {
          "@context" : "http://schema.org",
          "@type": "BlogPosting",
            "mainEntityOfPage":{
            "@type":"WebPage",
            "@id":"https:\/\/cezarypiatek.github.io\/post\/methods-with-special-signature\/"
            },
          "headline" : "The Magical Methods in C#",
          "author" : {
            "@type" : "Person",
            "name" : "CEZARY PIÄ„TEK"
          },
          "publisher" : {
            "@type" : "Person",
            "name" : "CEZARY PIÄ„TEK"
          },
          "datePublished" : "2020-06-30",
          "dateModified" : "2020-07-02",
          "image" : "https:\/\/cezarypiatek.github.io\/post\/methods-with-special-signature\/splashscreen.jpg",
          "description": "Methods with specific signature which have a special support in C#"
        }
        </script>
        
    <meta property="article:published_time" content="2020-06-30">
	<meta property="og:type" content="article">
    
	<meta property="og:locale" content="en_US">	
	<meta property="og:url" content="https://cezarypiatek.github.io/post/methods-with-special-signature/">	
	<meta property="og:title" content="The Magical Methods in C#">
	<meta property="og:image" content="https://cezarypiatek.github.io/post/methods-with-special-signature/splashscreen.jpg">
    <meta property="og:description" content="Methods with specific signature which have a special support in C#">
    <meta property="og:site_name" content="Cezary PiÄ…tek Blog">
    
    <meta property="og:tags" content="c#">
    
    <meta property="og:tags" content="protobuf">
    
    <meta property="og:tags" content="linq">
    
	<meta property="twitter:card" content="summary_large_image" >
	<meta property="twitter:image" content="https://cezarypiatek.github.io/post/methods-with-special-signature/splashscreen.jpg">
	<meta property="twitter:title" content="The Magical Methods in C#">	
	<meta property="twitter:creator" content="@cezary_piatek">
	<meta property="twitter:description" content="Methods with specific signature which have a special support in C#">

	<meta name="keywords" value="c#, protobuf, linq" />
    <meta name="generator" content="Hugo 0.74.3" />
    <title>The Magical Methods in C# &middot; Cezary PiÄ…tek Blog</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/a11y-dark.min.css">
    
    <link rel="stylesheet" href="https://cezarypiatek.github.io/css/style.css">
    <link rel="stylesheet" href="https://cezarypiatek.github.io/lib/gifplayer/gifplayer.css">
    
    <link href="https://cezarypiatek.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Cezary PiÄ…tek Blog" />
        
	<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
	<link rel="manifest" href="../../manifest.json">
  <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/story-show-gallery@2/dist/ssg.min.css">
    
    
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="https://cezarypiatek.github.io/">CEZARY PIÄ„TEK</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="https://cezarypiatek.github.io/">Blog</a></li>
				
					<li><a href="https://cezarypiatek.github.io/projects/">Projects</a></li>
				
					<li><a href="https://cezarypiatek.github.io/public-speaking/">Public speaking</a></li>
				
					<li><a href="https://cezarypiatek.github.io/about/">About me</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="https://cezarypiatek.github.io/">CEZARY PIÄ„TEK</a></h1>
		
		
		
			<small class="text-center center-block">Natural born software developer</small>
		
		
		
			<img id="profile-pic" src="https://cezarypiatek.github.io//images/7759991.jpg" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			
				<a href="https://github.com/cezarypiatek" title="Check my Open Source works"><i class="fa fa-github fa-2x"></i></a>
			
				<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fpublish.twitter.com%2F%3FbuttonType%3DFollowButton%26query%3D%2540cezary_piatek%26widget%3DButton&amp;ref_src=twsrc%5Etfw&amp;region=follow_link&amp;screen_name=cezary_piatek&amp;tw_p=followbutton" title="Follow me on Twitter"><i class="fa fa-twitter fa-2x"></i></a>
			
				<a href="https://www.linkedin.com/in/cezary-pi%C4%85tek-373737185/" title="Follow me on LinkedIn"><i class="fa fa-linkedin fa-2x"></i></a>
			
				<a href="https://stackoverflow.com/users/876060/cezarypiatek" title="Check my StackOverflow profile"><i class="fa fa-stack-overflow fa-2x"></i></a>
			
				<a href="../../index.xml" title="Be up to date - subscribe to my rss feed channel"><i class="fa fa-rss fa-2x"></i></a>
			

			
		</div>
		<div id="links" class="text-center">
			
			
				<a href="https://cezarypiatek.github.io/">Blog</a>
			
				<a href="https://cezarypiatek.github.io/projects/">Projects</a>
			
				<a href="https://cezarypiatek.github.io/public-speaking/">Public speaking</a>
			
				<a href="https://cezarypiatek.github.io/about/">About me</a>
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8 ssg">

<main>
	<article>
		<header>
			<h1>The Magical Methods in C#</h1>
			  
			<div><i class="fa fa-calendar"></i> <time>30 June 2020</time></div>
			<hr />
			
		</header>
		
			<img src="splashscreen.jpg" width="100%" />
			<br />
		
		<p>There&rsquo;s a certain set of special method signatures in C# which have particular support on the language level.
Methods with those signatures allow for using a special syntax which has several benefits. For example, we can use them to simplify our code or create <code>DSL</code> to express a solution to our domain-specific problem in a much cleaner way. I came across those methods in different places, so I decided to create a blog post to summarize all my discoveries on this subject.</p>
<h2 id="collection-initialization-syntax">Collection initialization syntax<a href="#collection-initialization-syntax" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p><a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/object-and-collection-initializers#collection-initializers">Collection initializer</a> is a quite old feature, as it exists in the language since version 3 (released in late 2007). Just as a reminder, <code>Collection initializer</code> allows for pre-populating a list by providing elements inside the block statement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> list = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">int</span>&gt; { <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>};
</code></pre></div><p>This translates simply to the following list of statements:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> list = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">int</span>&gt;();
list.Add(<span style="color:#ae81ff">1</span>);
list.Add(<span style="color:#ae81ff">2</span>);
list.Add(<span style="color:#ae81ff">3</span>);
</code></pre></div><p><code>Collection initializer</code> is not characteristic only for arrays and collection types from <code>BCL</code> but can be used with any type meeting the following conditions:</p>
<ul>
<li>Implements <code>IEnumerable</code> interface</li>
<li>Declares method with <code>void Add(T item)</code> signature</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomList</span>&lt;T&gt;: IEnumerable
{
    <span style="color:#66d9ef">public</span> IEnumerator GetEnumerator() =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Add(T item) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
}
</code></pre></div><p>We can add support for <code>Collection initializer</code> to existing types by defining the <code>Add</code> method as an extension method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExistingTypeExtensions</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Add&lt;T&gt;(ExistingType @this, T item) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
}
</code></pre></div><p>This syntax can be also used to insert elements into the collection field without accessible setter in initialization block:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomType</span>
{
    <span style="color:#66d9ef">public</span> List&lt;<span style="color:#66d9ef">string</span>&gt; CollectionField { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }  = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">string</span>&gt;();
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
    {
        <span style="color:#66d9ef">var</span> obj = <span style="color:#66d9ef">new</span> CustomType
        {
            CollectionField = 
            {
                <span style="color:#e6db74">&#34;item1&#34;</span>,
                <span style="color:#e6db74">&#34;item2&#34;</span>
            }
        };
    }
}

</code></pre></div><p><code>Add</code> method can have more than one parameter:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomList</span>&lt;T&gt;: IEnumerable
{
    <span style="color:#66d9ef">public</span> IEnumerator GetEnumerator() =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Add(T item, <span style="color:#66d9ef">string</span> extraParam1, <span style="color:#66d9ef">int</span> extraParam1) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
}
</code></pre></div><p>To use this overload inside the initialization block we need to wrap all parameters in extra pair of curly braces:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> obj = <span style="color:#66d9ef">new</span> CustomType
{
    CollectionField = 
    {
        {<span style="color:#e6db74">&#34;item1&#34;</span>, <span style="color:#e6db74">&#34;extraParamVal1&#34;</span>, <span style="color:#ae81ff">2</span> },
        {<span style="color:#e6db74">&#34;item2&#34;</span>, <span style="color:#e6db74">&#34;extraParamVal2&#34;</span>, <span style="color:#ae81ff">3</span> }
    }
};
</code></pre></div><p><code>Collection initializer</code> is quite often used to initialize collection with a well known number of items, but we can utilize it to set up collection with a dynamic number of elements. In both cases the syntax is identical:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> obj = <span style="color:#66d9ef">new</span> CustomType
{
    CollectionField = 
    {
       existingItems
    }
};
</code></pre></div><p>This is possible for types which meet the following conditions:</p>
<ul>
<li>Implements <code>IEnumerable</code> interface</li>
<li>Declares method with <code>void Add(IEnumerable&lt;T&gt; items)</code> signature</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomList</span>&lt;T&gt;: IEnumerable
{
    <span style="color:#66d9ef">public</span> IEnumerator GetEnumerator() =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Add(IEnumerable&lt;T&gt; items) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
}
</code></pre></div><p>Unfortunately, array type and collections from <code>BCL</code> don&rsquo;t implement <code>void Add(IEnumerable&lt;T&gt; items)</code> method, but we could easily change that by defining an extension method for the existing collection types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ListExtensions</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Add&lt;T&gt;(<span style="color:#66d9ef">this</span> List&lt;T&gt; @this, IEnumerable&lt;T&gt; items) =&gt; @this.AddRange(items);
}

</code></pre></div><p>Thanks to this extension method it&rsquo;s now possible to write code which looks as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> obj = <span style="color:#66d9ef">new</span> CustomType
{
    CollectionField = 
    {
        existingItems.Where(x =&gt; <span style="color:#75715e">/*Filter items*/</span>) .Select(x =&gt; <span style="color:#75715e">/*Map items*/</span>) 
    }
};
</code></pre></div><p>or even compose the resulting collection from the mix of individual elements and results of multiple <code>enumerables</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> obj = <span style="color:#66d9ef">new</span> CustomType
{
    CollectionField = 
    {
        individualElement1,
        individualElement2,
        list1.Where(x =&gt; <span style="color:#75715e">/*Filter items*/</span>) .Select(x =&gt; <span style="color:#75715e">/*Map items*/</span>),
        list2.Where(x =&gt; <span style="color:#75715e">/*Filter items*/</span>) .Select(x =&gt; <span style="color:#75715e">/*Map items*/</span>)
    }
};
</code></pre></div><p>Without this syntax, it would be very hard to achieve a similar result inside the initialization block.</p>
<p>I&rsquo;ve discovered this language feature by accident while working with mappings for types with collection fields generated from <code>protobuf</code> contracts. For those of you who are not familiar with <code>protobuf</code>, if you are using <a href="https://developers.google.com/protocol-buffers/docs/reference/csharp-generated">grpctools</a> to generate dotnet types from <code>proto</code> files, all collection fields are generated as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#a6e22e">[DebuggerNonUserCode]</span>
<span style="color:#66d9ef">public</span> RepeatableField&lt;ItemType&gt; SomeCollectionField
{
    <span style="color:#66d9ef">get</span>
    {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.someCollectionField_;
    }
}
</code></pre></div><p>As you can see, collection fields in generated code don&rsquo;t have a setter, but a blessing in disguise, <a href="https://developers.google.com/protocol-buffers/docs/reference/csharp/class/google/protobuf/collections/repeated-field-t-">RepeatableField<T></a> implements <a href="https://developers.google.com/protocol-buffers/docs/reference/csharp/class/google/protobuf/collections/repeated-field-t-#class_google_1_1_protobuf_1_1_collections_1_1_repeated_field_3_01_t_01_4_1a6d0e9efbac818182068afae48b8d4599">void Add(IEnumerable<T> items)</a> so we can still initialize them inside the initialization block:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Adds all of the specified values into this collection. This method is present to
</span><span style="color:#75715e">/// allow repeated fields to be constructed from queries within collection initializers.
</span><span style="color:#75715e">/// Within non-collection-initializer code, consider using the equivalent &lt;see cref=&#34;AddRange&#34;/&gt;
</span><span style="color:#75715e">/// method instead for clarity.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;param name=&#34;values&#34;&gt;The values to add to this collection.&lt;/param&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Add(IEnumerable&lt;T&gt; values)
{
    AddRange(values);
}
</code></pre></div><h2 id="dictionary-initialization-syntax">Dictionary initialization syntax<a href="#dictionary-initialization-syntax" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>One of the cool features introduced in C# 6 was <a href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-6#initialize-associative-collections-using-indexers">Index initializers</a> which simplified syntax for dictionary initialization. Thanks to that we can write dictionary init code in a much more readable way:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> errorCodes = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>&gt;
{
<span style="color:#a6e22e">    [404]</span> = <span style="color:#e6db74">&#34;Page not Found&#34;</span>,
<span style="color:#a6e22e">    [302]</span> = <span style="color:#e6db74">&#34;Page moved, but left a forwarding address.&#34;</span>,
<span style="color:#a6e22e">    [500]</span> = <span style="color:#e6db74">&#34;The web server can&#39;t come out to play today.&#34;</span>
};
</code></pre></div><p>This code is translated to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> errorCodes = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>&gt;();
errorCodes[<span style="color:#ae81ff">404</span>] = <span style="color:#e6db74">&#34;Page not Found&#34;</span>;    
errorCodes[<span style="color:#ae81ff">302</span>] = <span style="color:#e6db74">&#34;Page moved, but left a forwarding address.&#34;</span>;    
errorCodes[<span style="color:#ae81ff">500</span>] = <span style="color:#e6db74">&#34;The web server can&#39;t come out to play today.&#34;</span>;    
</code></pre></div><p>It&rsquo;s not much but it definitely results with a better experience for writing and reading the code.</p>
<p>The best thing about <code>Index initializer</code> is that it is not limited only to <code>Dictionary&lt;&gt;</code> class, it can be used with any type which defines an <code>indexer</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpHeaders</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">this</span>[<span style="color:#66d9ef">string</span> key]
    {
        <span style="color:#66d9ef">get</span> =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
        <span style="color:#66d9ef">set</span> =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
    {
        <span style="color:#66d9ef">var</span> headers = <span style="color:#66d9ef">new</span> HttpHeaders
        {
<span style="color:#a6e22e">            [&#34;access-control-allow-origin&#34;]</span> = <span style="color:#e6db74">&#34;*&#34;</span>,
<span style="color:#a6e22e">            [&#34;cache-control&#34;]</span> = <span style="color:#e6db74">&#34;max-age=315360000, public, immutable&#34;</span>
        };
    }
}
</code></pre></div><h2 id="deconstructors">Deconstructors<a href="#deconstructors" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>In C# 7.0, together with tuples, a deconstructor mechanism has been introduced. Deconstructors allow for &ldquo;decomposing&rdquo; a tuple into a set of individual variables as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> point = (<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">7</span>);
<span style="color:#75715e">// decomposing tuple into separated variables
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> (x, y) = point;
</code></pre></div><p>which is equivalent to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs">ValueTuple&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>&gt; point = <span style="color:#66d9ef">new</span> ValueTuple&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>&gt;(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>);
<span style="color:#66d9ef">int</span> x = point.Item1;
<span style="color:#66d9ef">int</span> y = point.Item2;
</code></pre></div><p>This syntax allows also for switching values of two variables without the need for an explicit declaration of the third variable:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">5</span>, y = <span style="color:#ae81ff">7</span>;
<span style="color:#75715e">//switch
</span><span style="color:#75715e"></span>(x, y) = (y,x);
</code></pre></div><p>&hellip; or for a more succinct way of member initialization:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Point</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> X { <span style="color:#66d9ef">get</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Y { <span style="color:#66d9ef">get</span>; }

    <span style="color:#66d9ef">public</span> Point(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y)  =&gt; (X, Y) = (x, y);
}
</code></pre></div><p>Deconstructors can be used not only with tuples but with custom types too. To allow for deconstructing custom type, it needs to implement a method that obeys the following rules:</p>
<ul>
<li>It&rsquo;s named <code>Deconstruct</code></li>
<li>Returns void</li>
<li>Every parameter has to be defined with <code>out</code> modifier</li>
</ul>
<p>For our type <code>Point</code> we can define deconstructor in the following way:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Point</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> X {<span style="color:#66d9ef">get</span>;}
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Y {<span style="color:#66d9ef">get</span>;}

    <span style="color:#66d9ef">public</span> Point(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y) =&gt; (X, Y) = (x, y);
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Deconstruct(<span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> y) =&gt; (x, y) = (X, Y);
}
</code></pre></div><p>and sample usage can look as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">var</span> point = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>);
<span style="color:#66d9ef">var</span> (x, y)= point;        
</code></pre></div><p>which under the hood is translated to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">int</span> x;
<span style="color:#66d9ef">int</span> y;
<span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>).Deconstruct(<span style="color:#66d9ef">out</span> x, <span style="color:#66d9ef">out</span> y);
</code></pre></div><p>Deconstructors can be added to types declared outside the source code by defining them as an extension method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PointExtensions</span>
{
     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Deconstruct(<span style="color:#66d9ef">this</span> Point @this, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> y) =&gt; (x, y) = (@this.X, @this.Y);
}
</code></pre></div><p>One of the most useful examples of deconstructors is the one for <code>KeyValuePair&lt;TKey,TValue&gt;</code>, which allows for easy access to key and value while iterating over a dictionary:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> (key, <span style="color:#66d9ef">value</span>) <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>&gt; { [<span style="color:#ae81ff">1</span>] = <span style="color:#e6db74">&#34;val1&#34;</span>, [<span style="color:#ae81ff">2</span>] = <span style="color:#e6db74">&#34;val2&#34;</span> })
{
    <span style="color:#75715e">//TODO: Do something
</span><span style="color:#75715e"></span>}
</code></pre></div><p><code>KeyValuePair&lt;TKey,TValue&gt;.Deconstruct(TKey, TValue) </code> is available only from <code>netstandard2.1</code>. For previous <code>netstandard</code> versions we need to add it manually using the approach with the extension method.</p>
<h2 id="custom-awaitable-types">Custom awaitable types<a href="#custom-awaitable-types" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>C# 5 (released together with Visual Studio 2012) introduced an <code>async/await</code> mechanism which was a real game-changer in the area of asynchronous programming. Before that, handling invocation of asynchronous methods resulted very often in quite a messy code, especially when there was more than one asynchronous invocation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">void</span> DoSomething()
{
    DoSomethingAsync().ContinueWith((task1) =&gt; {
        <span style="color:#66d9ef">if</span> (task1.IsCompletedSuccessfully)
        {
            DoSomethingElse1Async(task1.Result).ContinueWith((task2) =&gt; {
                <span style="color:#66d9ef">if</span> (task2.IsCompletedSuccessfully)
                {
                    DoSomethingElse2Async(task2.Result).ContinueWith((task3) =&gt; {
                        <span style="color:#75715e">//TODO: Do something
</span><span style="color:#75715e"></span>                    });
                }
            });
        }
    });
}

<span style="color:#66d9ef">private</span> Task&lt;<span style="color:#66d9ef">int</span>&gt; DoSomethingAsync() =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
<span style="color:#66d9ef">private</span> Task&lt;<span style="color:#66d9ef">int</span>&gt; DoSomethingElse1Async(<span style="color:#66d9ef">int</span> i) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
<span style="color:#66d9ef">private</span> Task&lt;<span style="color:#66d9ef">int</span>&gt; DoSomethingElse2Async(<span style="color:#66d9ef">int</span> i) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
</code></pre></div><p>With <code>async/await</code> syntax this can be written in a much cleaner way:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">async</span> Task DoSomething()
{
    <span style="color:#66d9ef">var</span> res1 = <span style="color:#66d9ef">await</span> DoSomethingAsync();
    <span style="color:#66d9ef">var</span> res2 = <span style="color:#66d9ef">await</span> DoSomethingElse1Async(res1);
    <span style="color:#66d9ef">await</span> DoSomethingElse2Async(res2);
}
</code></pre></div><p>This might be surprising, but the <code>await</code> keyword is not reserved to work only with the <code>Task</code> type. It can be used with any type which contains a method called <code>GetAwaiter</code> and  returns type that meets the following requirement:</p>
<ul>
<li>Implements the <code>System.Runtime.CompilerServices.INotifyCompletion</code> interface with <code>void OnCompleted(Action continuation)</code> method.</li>
<li>Contains the <code>IsCompleted</code> boolean property.</li>
<li>Contains the  parameter-less <code>GetResult</code> method .</li>
</ul>
<p>To add support of <code>await</code> keyword to the custom type we need to define <code>GetAwaiter</code> method that returns an instance of <code>TaskAwaiter&lt;TResult&gt;</code> or a custom type that meets aforementioned conditions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomAwaitable</span>
{
    <span style="color:#66d9ef">public</span> CustomAwaiter GetAwaiter() =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomAwaiter</span>: INotifyCompletion
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> OnCompleted(Action continuation) =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsCompleted =&gt; =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> GetResult() =&gt; <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
}
</code></pre></div><p>You may wonder what could be a possible scenario of using <code>await</code> syntax with custom awaitable type. If that&rsquo;s the case, I highly recommend reading the article from <a href="https://devblogs.microsoft.com/pfxteam/author/toub/">Stephen Toub</a> entitled &ldquo;<a href="https://devblogs.microsoft.com/pfxteam/await-anything/">await anything</a>&rdquo; which provides plenty of interesting examples.</p>
<h2 id="the-query-expression-pattern">The query expression pattern<a href="#the-query-expression-pattern" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>The best invention of C# 3.0 was definitely <code>Language-Integrated Query</code>, known as <code>LINQ</code>, which allows for collection manipulation using SQL-like syntax.<code>LINQ</code> comes in two variations: SQL-like syntax and Extension method syntax. I prefer the second one because in my opinion it is more readable, but it&rsquo;s probably because I&rsquo;m accustomed to it. An interesting fact about the SQL-like syntax is that it is translated into the Extension method syntax during the compilation because it&rsquo;s a C#, not <code>CLR</code> feature. <code>LINQ</code> was invented in the first place to work with <code>IEnumerable</code>, <code>IEnumerable&lt;T&gt;</code> and <code>IQueryable&lt;T&gt;</code> types but it&rsquo;s not limited to them, we can use it with any type that meets requirements of <a href="https://github.com/dotnet/csharplang/blob/master/spec/expressions.md#the-query-expression-pattern">query expression pattern</a>. The complete set of method signatures used by <code>LINQ</code> looks as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span>
{
    <span style="color:#66d9ef">public</span> C&lt;T&gt; Cast&lt;T&gt;();
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span>&lt;T&gt; : C
{
    <span style="color:#66d9ef">public</span> C&lt;T&gt; Where(Func&lt;T,<span style="color:#66d9ef">bool</span>&gt; predicate);

    <span style="color:#66d9ef">public</span> C&lt;U&gt; Select&lt;U&gt;(Func&lt;T,U&gt; selector);

    <span style="color:#66d9ef">public</span> C&lt;V&gt; SelectMany&lt;U,V&gt;(Func&lt;T,C&lt;U&gt;&gt; selector, Func&lt;T,U,V&gt; resultSelector);

    <span style="color:#66d9ef">public</span> C&lt;V&gt; Join&lt;U,K,V&gt;(C&lt;U&gt; inner, Func&lt;T,K&gt; outerKeySelector, Func&lt;U,K&gt; innerKeySelector, Func&lt;T,U,V&gt; resultSelector);

    <span style="color:#66d9ef">public</span> C&lt;V&gt; GroupJoin&lt;U,K,V&gt;(C&lt;U&gt; inner, Func&lt;T,K&gt; outerKeySelector, Func&lt;U,K&gt; innerKeySelector, Func&lt;T,C&lt;U&gt;,V&gt; resultSelector);

    <span style="color:#66d9ef">public</span> O&lt;T&gt; OrderBy&lt;K&gt;(Func&lt;T,K&gt; keySelector);

    <span style="color:#66d9ef">public</span> O&lt;T&gt; OrderByDescending&lt;K&gt;(Func&lt;T,K&gt; keySelector);

    <span style="color:#66d9ef">public</span> C&lt;G&lt;K,T&gt;&gt; GroupBy&lt;K&gt;(Func&lt;T,K&gt; keySelector);

    <span style="color:#66d9ef">public</span> C&lt;G&lt;K,E&gt;&gt; GroupBy&lt;K,E&gt;(Func&lt;T,K&gt; keySelector, Func&lt;T,E&gt; elementSelector);
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">O</span>&lt;T&gt; : C&lt;T&gt;
{
    <span style="color:#66d9ef">public</span> O&lt;T&gt; ThenBy&lt;K&gt;(Func&lt;T,K&gt; keySelector);

    <span style="color:#66d9ef">public</span> O&lt;T&gt; ThenByDescending&lt;K&gt;(Func&lt;T,K&gt; keySelector);
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">G</span>&lt;K,T&gt; : C&lt;T&gt;
{
    <span style="color:#66d9ef">public</span> K Key { <span style="color:#66d9ef">get</span>; }
}
</code></pre></div><p>Of course, we don&rsquo;t need to implement all of those methods to use <code>LINQ</code> syntax with our custom type. The list of <code>LINQ</code> operators and methods required for them can be found <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/linq/query-expression-syntax-for-standard-query-operators">here</a>. <code>LINQ</code> syntax with custom types is very often used to implement monads. A really good explanation how to do it can be found in the article <a href="https://codewithstyle.info/understand-monads-linq/">Understand monads with LINQ</a> by <a href="http://miloszpiechocki.com/">MiÅ‚osz Piechocki</a></p>
<h2 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> </h2>
<p>The purpose of this article was not to encourage you to abuse those syntax tricks but rather to demystify them. On the other hand, they should not be completely avoided. They were invented to be used, and sometimes they can make your code much cleaner. If you are afraid that the resulting code might not be so obvious to your teammates, you should find a way to share your knowledge or at least link to this article ;)
I&rsquo;m not sure if it&rsquo;s a complete set of those &ldquo;magical methods&rdquo; - if you know any others, I would appreciate you sharing that in the comment section below.</p>
    
		
		<hr/>  
		<p>If you find this blog post useful and you think it's worth to share this idea with others, please don't hesitate to use these buttons below:</p>	
		<div class="addthis_inline_share_toolbox"></div>
		
	</article>
	
	
	<h3>See Also</h3>
	<div class="row">
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/auto-generated-web-api-client/" >
						<div class="card">
								<img class="card-img-top" src="../../post/auto-generated-web-api-client/splashscreen_hua05f900ef5215c00a4b82e282bbff4e6_76712_320x240_fill_q75_box_smart1.jpg" alt="Auto generated WebAPI client library with NSwag">
								<div class="card-body">
									<h5 class="card-title">Auto generated WebAPI client library with NSwag</h5>											  
								</div>
							</div></a>
				</div>		
			
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/dapper-tips-and-tricks/" >
						<div class="card">
								<img class="card-img-top" src="../../post/dapper-tips-and-tricks/splashscreen_hu934097d2f008fa5010efd29b702bfdce_90880_320x240_fill_q75_box_smart1.jpg" alt="Working efficiently with legacy database using Dapper">
								<div class="card-body">
									<h5 class="card-title">Working efficiently with legacy database using Dapper</h5>											  
								</div>
							</div></a>
				</div>		
			
		
			
				
				
				
				<div class="col-md-4 col-sm-12">
						<a href="../../post/csharp-twin-types/" >
						<div class="card">
								<img class="card-img-top" src="../../post/csharp-twin-types/splashscreen_hu79ad02ab373e041bd343579fd88dc5ca_155528_320x240_fill_q75_box_smart1.jpg" alt="Twin types - properties synchronization without inheritance">
								<div class="card-body">
									<h5 class="card-title">Twin types - properties synchronization without inheritance</h5>											  
								</div>
							</div></a>
				</div>		
			
		
	</div>
	<br />
	
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" https://cezarypiatek.github.io/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>
  
	
	  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "cezarypiatek-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	

						  </div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
     if (window.location.hostname === "localhost") {
		console.log("Analytics not running on local dev.");		
	}else{
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-18735584-9', 'auto');
		ga('send', 'pageview');
		window.baseURL = "https:\/\/cezarypiatek.github.io\/";
	}
  </script>
  

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/story-show-gallery@2/dist/ssg.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
		
  
  <script src="../../lib/gifplayer/jquery.gifplayer.js"></script>
  <script>
	   $(document).ready(function(){   
		$("img[src$='_animated.png']").gifplayer({
			label: "â–¶"
		});
	  });
  </script>
  <script src="https://cezarypiatek.github.io//js/App.js"></script>
  
  <script type="text/javascript">
	var addthis_share = addthis_share || {}
	addthis_share = {
		passthrough : {
			twitter: {
				via: "cezary_piatek",
				hashtags: "csharp,protobuf,linq"
			}
		}
	}
	</script> 
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a286b9b1c027c15" async></script>
  
    
	<script src="//cdn.rawgit.com/mburakerman/prognroll/master/src/prognroll.js"></script>
	<script>
		$(function() {
		  $("#content").prognroll({
    custom: true
  });
		});
	</script>

</body>
</html>
